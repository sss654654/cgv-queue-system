# ===============================================================
#          Default / Local Profile
# ===============================================================
# 로컬 개발 시 기본으로 활성화되는 프로필.
# 모든 값이 하드코딩되어 환경 변수 없이 즉시 실행 가능하다.
# ---------------------------------------------------------------

# Admission Control (대기열 시스템) 설정
admission:
  enable-dynamic-scaling: ${ENABLE_DYNAMIC_SCALING:true}
  base-sessions-per-pod: ${BASE_SESSIONS_PER_POD:2}
  max-total-sessions: ${MAX_TOTAL_SESSIONS:50}
  fallback-pod-count: ${FALLBACK_POD_COUNT:1}
  session-timeout-seconds: ${SESSION_TIMEOUT:300}

# Queue Processor 설정
queue:
  process-interval: ${QUEUE_PROCESS_INTERVAL:2000}
  target-movie-id: movie-topgun2
  processing-batch-size: ${PROCESSING_BATCH_SIZE:100}

# Kubernetes Pod Discovery
kubernetes:
  namespace: ${KUBERNETES_NAMESPACE:default}
admission-discovery:
  enable-k8s-discovery: ${ENABLE_K8S_DISCOVERY:true}

spring:
  # 기본 활성 프로필
  profiles:
    active: local

  application:
    name: cgv-backend

  # 로컬 .env 파일 지원
  config:
    import: optional:file:.env[.properties]

  # ========== 데이터소스 설정 (Write/Read 분리) ==========
  datasource:
    write:
      name: write
      jdbc-url: jdbc:mysql://${WRITE_URL:localhost}:${WRITE_PORT:3306}/${DB:cgv}
      driver-class-name: com.mysql.cj.jdbc.Driver
      username: ${USERNAME:root}
      password: ${PASSWORD:password}
      hikari:
        maximum-pool-size: 10
        minimum-idle: 5
    read:
      name: read
      jdbc-url: jdbc:mysql://${READ_URL:localhost}:${READ_PORT:3306}/${DB:cgv}
      driver-class-name: com.mysql.cj.jdbc.Driver
      username: ${USERNAME:root}
      password: ${PASSWORD:password}
      hikari:
        maximum-pool-size: 10
        minimum-idle: 5

  # ========== JPA / Hibernate ==========
  jpa:
    database-platform: org.hibernate.dialect.MySQL8Dialect
    show-sql: true
    hibernate:
      ddl-auto: create-drop
    properties:
      hibernate:
        format_sql: true
        use_sql_comments: true
    defer-datasource-initialization: false

  # ========== Redis ==========
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      timeout: 2000ms
      ssl:
        enabled: ${REDIS_SSL_ENABLED:false}
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 0

  # DB 초기화 SQL
  sql:
    init:
      mode: always
      data-locations: classpath:data.sql

# ========== Server ==========
server:
  port: 8080
  servlet:
    context-path: /
  tomcat:
    connection-timeout: 120000
    max-connections: 12000
    threads:
      max: 400
    accept-count: 200

# ========== Actuator / Prometheus ==========
management:
  endpoints:
    web:
      exposure:
        include: health,prometheus,info
  endpoint:
    health:
      show-details: when_authorized
  metrics:
    tags:
      application: cgv-backend

# ========== Logging ==========
logging:
  level:
    com.example: DEBUG
    com.example.admission.QueueProcessor: WARN
    org.springframework.web: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

# ========== Swagger ==========
springdoc:
  api-docs:
    path: /v3/api-docs
    enabled: true
  swagger-ui:
    path: /swagger-ui.html
    enabled: true
    operationsSorter: method
    tagsSorter: alpha
    display-request-duration: true
  default-consumes-media-type: application/json
  default-produces-media-type: application/json

---
# ===============================================================
#          Dev Profile (K8s Dev Namespace)
# ===============================================================
# EKS dev namespace에서 실행. Redis는 cgv-dev namespace의 Pod.
# 값은 configmap.yaml 환경 변수로 주입된다.
# ---------------------------------------------------------------
spring:
  config:
    activate:
      on-profile: dev

  datasource:
    write:
      jdbc-url: jdbc:mysql://${WRITE_URL:localhost}:3306/cgv_dev
      username: ${DB_USERNAME:cgv_dev_user}
      password: ${DB_PASSWORD:}
      hikari:
        maximum-pool-size: 10
        minimum-idle: 5
    read:
      jdbc-url: jdbc:mysql://${READ_URL:localhost}:3306/cgv_dev
      username: ${DB_USERNAME:cgv_dev_user}
      password: ${DB_PASSWORD:}
      hikari:
        maximum-pool-size: 10
        minimum-idle: 5

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: false

  data:
    redis:
      host: ${REDIS_HOST:redis.cgv-dev.svc.cluster.local}
      port: 6379
      timeout: 2000ms
      ssl:
        enabled: false
      lettuce:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 2

  sql:
    init:
      mode: never

admission:
  base-sessions-per-pod: ${BASE_SESSIONS_PER_POD:10}
  max-total-sessions: ${MAX_TOTAL_SESSIONS:20}
  session-timeout-seconds: ${SESSION_TIMEOUT:300}

queue:
  process-interval: ${QUEUE_PROCESS_INTERVAL:5000}
  processing-batch-size: ${PROCESSING_BATCH_SIZE:100}

kubernetes:
  namespace: cgv-dev

logging:
  level:
    com.example: INFO
    org.hibernate.SQL: WARN

---
# ===============================================================
#          Prod Profile (EKS Production)
# ===============================================================
# ElastiCache cache.t3.small (Non-Cluster, Multi-AZ Replica),
# RDS MySQL (Multi-AZ), IRSA credentials.
#
# 핵심 숫자:
#   max-total-sessions: 5,000 (10 Pod x 500명)
#   session-timeout: 600초 (10분)
#   processing-batch-size: 5,000
#   Redis pool: max-active=50, SSL=true
# ---------------------------------------------------------------
spring:
  config:
    activate:
      on-profile: prod

  websocket:
    message-size-limit: 131072
    send-buffer-size-limit: 1048576
    send-time-limit: 30000

  datasource:
    write:
      jdbc-url: jdbc:mysql://${WRITE_URL}:3306/cgv_prod
      username: ${DB_USERNAME:cgv_prod_user}
      password: ${DB_PASSWORD}
      hikari:
        maximum-pool-size: 5
        minimum-idle: 2
        connection-timeout: 20000
        idle-timeout: 300000
        max-lifetime: 1200000
    read:
      jdbc-url: jdbc:mysql://${READ_URL}:3306/cgv_prod
      username: ${DB_USERNAME:cgv_prod_user}
      password: ${DB_PASSWORD}
      hikari:
        maximum-pool-size: 5
        minimum-idle: 2

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false

  data:
    redis:
      host: ${REDIS_HOST}
      port: 6379
      password: ${REDIS_PASSWORD:}
      timeout: 5000ms
      ssl:
        enabled: true
      lettuce:
        pool:
          max-active: 50
          max-idle: 20
          min-idle: 5
          max-wait: 5000

  sql:
    init:
      mode: never

  lifecycle:
    timeout-per-shutdown-phase: 30s

admission:
  base-sessions-per-pod: ${BASE_SESSIONS_PER_POD:500}
  max-total-sessions: ${MAX_TOTAL_SESSIONS:5000}
  fallback-pod-count: ${FALLBACK_POD_COUNT:3}
  session-timeout-seconds: ${SESSION_TIMEOUT:600}

queue:
  process-interval: ${QUEUE_PROCESS_INTERVAL:2000}
  processing-batch-size: ${PROCESSING_BATCH_SIZE:5000}

server:
  shutdown: graceful

kubernetes:
  namespace: cgv-api
  app-label: app.kubernetes.io/name=cgv-api

logging:
  level:
    com.example: INFO
    com.example.admission: INFO
    org.springframework.web.socket: WARN
    org.springframework.messaging: WARN
    org.hibernate.SQL: WARN

management:
  endpoints:
    web:
      exposure:
        include: health,prometheus,info
  metrics:
    tags:
      application: cgv-backend
